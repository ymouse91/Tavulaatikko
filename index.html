<!DOCTYPE html>
<html lang="fi">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#cfc">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tavupeli</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
    }

    .grid {
      display: grid;
      gap: 5px;
      justify-content: center;
      margin: 20px auto;
    }

    .grid button {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #888;
      background-color: #f0f0f0;
      cursor: pointer;
      transition: background 0.2s ease;
      width: 60px;
      height: 60px;
      font-size: 18px;
    }

    .grid button.correct {
      background-color: #cfc;
    }

    .controls {
      margin-bottom: 15px;
    }

    .won {
      font-weight: bold;
      color: green;
      font-size: 1.4em;
    }

.scroll-box {
  max-height: 200px;
  overflow-y: auto;
  margin: 10px auto;
  padding: 10px;
  border: 1px solid #ccc;
  width: 60%;
  min-width: 260px;      /* minimi leveys */
  max-width: 600px;      /* maksimi leveys */
  background: #f9f9f9;
  text-align: left;
  font-size: 18px;
}

  #sizeLabel,
    #size {
      font-size: 18px;
      font-weight: bold;
    }
  button:hover {
      background-color: #ddd;
    }
      /* Napit hover-v√§reill√§ */
    #startBtn:hover {
      background-color: #cfc;
    }
    #lopetaBtn:hover {
      background-color: #fdd;
    }
    #apuaBtn:hover {
      background-color: #fffbcc;
    }
	
button#startBtn,
button#lopetaBtn,
button#apuaBtn {
  font-size: 16px;
  padding: 2px 4px;
  border-radius: 6px;
  border: 1px solid #888;
  background-color: #f0f0f0;
  cursor: pointer;
  margin: 4px;
}
.scroll-box a {
  text-decoration: none;
  color: #000; /* halutessasi voit s√§ilytt√§√§ tumman v√§rin */
}
.scroll-box a:hover {
  text-decoration: underline;
  color: #0077cc;
}

  </style>
</head>
<body>
  <!-- K√§ytt√∂liittym√§n otsikko ja napit -->
  <h1>Tavulaatikko</h1>
  <div class="controls">
    <label for="size" id="sizeLabel">Valitse koko:</label>
    <select id="size">
      <option value="3" selected>3√ó3</option>
      <option value="4">4√ó4</option>
      <option value="5">5√ó5</option>
    </select>
    <button id="startBtn" onclick="startGame()" disabled>Aloita peli</button>
    <button id="lopetaBtn" onclick="naytaRatkaisu()" style="display:none">Lopeta ‚Äì n√§yt√§ ratkaisu</button>
    <button id="apuaBtn" onclick="annaApua()" style="display:none">Apua</button>
  </div>

  <!-- Peliruudukko ja tulosalue -->
  <div id="grid" class="grid"></div>
  <div id="status" class="won"></div>

  <!-- Varsinainen pelilogiikka alkaa -->
  <script>
    const gridElem = document.getElementById("grid");
    const statusElem = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const lopetaBtn = document.getElementById("lopetaBtn");

    // Pelin tilamuuttujat
    let koko = 3;
    let ratkaisu = [];
    let nykyinen = [];
    let valinta = null;
    let peliKaynnissa = true;
    let korostukset = new Set();
    let lukitut = new Set(); // ‚Üê t√§m√§ lis√§ttiin
    let sallitutSanat = new Set();
    let tavulista = [];

    // Ladataan sanalista tekstimuodossa (vain kerran)
    async function lataaSanat() {
      const response = await fetch("sallitut_sanat.txt");
      const teksti = await response.text();
      const rivit = teksti.split(/\r?\n/).filter(r => r.includes("-"));
      sallitutSanat = new Set(rivit);

      const kaikkiTavut = rivit.flatMap(r => r.split("-"));
      const laskuri = {};
      kaikkiTavut.forEach(t => laskuri[t] = (laskuri[t] || 0) + 1);
      tavulista = Object.keys(laskuri);

      startBtn.disabled = false;
    }

    // K√§ynnist√§√§ uuden pelin, piilottaa ja n√§ytt√§√§ napit oikein
    function startGame() {
      document.getElementById("size").style.display = "none";
      document.getElementById("sizeLabel").style.display = "none";
      document.getElementById("startBtn").style.display = "none";
      document.getElementById("lopetaBtn").style.display = "inline-block";
      document.getElementById("apuaBtn").style.display = "inline-block";

      statusElem.innerHTML = "";
      if (sallitutSanat.size === 0) {
        alert("Sanoja ei ladattu. Varmista, ett√§ sanalista on paikallaan ja ladattu.");
        return;
      }

      koko = parseInt(document.getElementById("size").value);
      ratkaisu = generoiKelvollinenRuudukko(koko);

      const tavut = ratkaisu.flat();
      korostukset.clear();
      lukitut.clear(); // ‚Üê T√§m√§ puuttui
      const oikeaIndeksi = Math.floor(Math.random() * tavut.length);
      const oikeaTavu = tavut[oikeaIndeksi];
      const tavutIlman = tavut.filter((_, i) => i !== oikeaIndeksi);
      const sekoitetut = shuffle(tavutIlman);
      sekoitetut.splice(oikeaIndeksi, 0, oikeaTavu);

      nykyinen = sekoitetut;
      korostukset.add(oikeaIndeksi);
	  lukitut.add(oikeaIndeksi); // ‚Üê t√§m√§ lukitsee alussa paljastetun tavun
      peliKaynnissa = true;
      valinta = null;

      render();
    }

    // Piirt√§√§ peliruudukon selaimeen
    function render() {
      gridElem.style.gridTemplateColumns = `repeat(${koko}, 60px)`;
      gridElem.innerHTML = "";

      for (let i = 0; i < koko * koko; i++) {
        const btn = document.createElement("button");
        btn.textContent = nykyinen[i];
        btn.onclick = () => valitseTaiVaihda(i);

        if (valinta === i) btn.style.background = "#ffc";
        if (korostukset.has(i)) btn.classList.add("correct");

        gridElem.appendChild(btn);
      }
    }

    // Vaihtaa kahden tavun paikkaa pelaajan klikkauksella
    function valitseTaiVaihda(i) {
      if (!peliKaynnissa) return;

      if (valinta === null) {
        valinta = i;
      } else if (valinta === i) {
        valinta = null;
      } else {
	    if (lukitut.has(i) || lukitut.has(valinta)) return; // ‚Üê lis√§tty ennen vaihtoa
        [nykyinen[i], nykyinen[valinta]] = [nykyinen[valinta], nykyinen[i]];
        valinta = null;
        tarkistaVoitto();
      }
      render();
    }

    // Arpoo ja muodostaa kelvollisen tavuruudukon
    function generoiKelvollinenRuudukko(n) {
      const grid = Array.from({ length: n }, () => Array(n).fill(""));
      const maxYritykset = 10000;
      let yritykset = 0;

      while (yritykset++ < maxYritykset) {
        const k√§ytetyt = {};

        for (let r = 0; r < n; r++) {
          for (let c = 0; c < n; c++) {
            const ehdokkaat = shuffle([...tavulista]);
            let asetettu = false;

            for (const tavu of ehdokkaat) {
              if ((k√§ytetyt[tavu] || 0) >= 1) continue;
              grid[r][c] = tavu;

              const vasenOk = c === 0 || sallitutSanat.has(`${grid[r][c-1]}-${tavu}`);
              const ylaOk = r === 0 || sallitutSanat.has(`${grid[r-1][c]}-${tavu}`);

              if (vasenOk && ylaOk) {
                k√§ytetyt[tavu] = (k√§ytetyt[tavu] || 0) + 1;
                asetettu = true;
                break;
              }
              grid[r][c] = "";
            }

            if (!asetettu) break;
          }
        }

        if (grid.flat().every(t => t)) return grid;
      }

      alert("Ei onnistuttu muodostamaan kelvollista ruudukkoa.");
      return Array.from({ length: n }, () => Array(n).fill("??"));
    }

    // Tarkistaa voiton ja n√§ytt√§√§ tulossanat vierityslaatikossa
    function naytaSanat(vaaka, pysty, otsikko) {
      statusElem.innerHTML = `
        <div>${otsikko}</div>
        <div class="scroll-box" style="display: flex; gap: 20px; justify-content: center;">
          <div><b>Vaakaan:</b><br>
            ${vaaka.map(s => `<a href='https://www.kielitoimistonsanakirja.fi/#/${s.replace("-", "").toLowerCase()}' target='_blank'>${s.replace("-", "")}</a>`).join("<br>")}
          </div>
          <div><b>Pystyyn:</b><br>
            ${pysty.map(s => `<a href='https://www.kielitoimistonsanakirja.fi/#/${s.replace("-", "").toLowerCase()}' target='_blank'>${s.replace("-", "")}</a>`).join("<br>")}
          </div>
        </div>`;
    }

    function tarkistaVoitto() {
      const grid = [];
      for (let r = 0; r < koko; r++) {
        grid.push(nykyinen.slice(r * koko, (r + 1) * koko));
      }

      for (let r = 0; r < koko; r++) {
        for (let c = 0; c < koko; c++) {
          if (c < koko - 1 && !sallitutSanat.has(`${grid[r][c]}-${grid[r][c+1]}`)) return;
          if (r < koko - 1 && !sallitutSanat.has(`${grid[r][c]}-${grid[r+1][c]}`)) return;
        }
      }

      const vaaka = [], pysty = [];
      for (let r = 0; r < koko; r++) {
        for (let c = 0; c < koko - 1; c++) {
          vaaka.push(`${grid[r][c]}-${grid[r][c+1]}`);
        }
      }
      for (let c = 0; c < koko; c++) {
        for (let r = 0; r < koko - 1; r++) {
          pysty.push(`${grid[r][c]}-${grid[r+1][c]}`);
        }
      }

      document.getElementById("size").style.display = "inline-block";
      document.getElementById("sizeLabel").style.display = "inline-block";
      document.getElementById("startBtn").style.display = "inline-block";
      document.getElementById("lopetaBtn").style.display = "none";
      document.getElementById("apuaBtn").style.display = "none";
      naytaSanat(vaaka, pysty, "Voitit!");
    }

    // N√§ytt√§√§ alkuper√§isen ratkaisun ja tulostaa sanat
    function naytaRatkaisu() {
      document.getElementById("size").style.display = "inline-block";
      document.getElementById("sizeLabel").style.display = "inline-block";
      document.getElementById("startBtn").style.display = "inline-block";
      document.getElementById("lopetaBtn").style.display = "none";
      document.getElementById("apuaBtn").style.display = "none";

      nykyinen = ratkaisu.flat();
      peliKaynnissa = false;
      render();

      const vaaka = [], pysty = [];
      for (let r = 0; r < koko; r++) {
        for (let c = 0; c < koko - 1; c++) {
          vaaka.push(`${ratkaisu[r][c]}-${ratkaisu[r][c+1]}`);
        }
      }
      for (let c = 0; c < koko; c++) {
        for (let r = 0; r < koko - 1; r++) {
          pysty.push(`${ratkaisu[r][c]}-${ratkaisu[r+1][c]}`);
        }
      }

      naytaSanat(vaaka, pysty, "Ratkaisun sanat.");
    }

// Paljastaa yhden oikeassa paikassa olevan tavun pelaajalle
function annaApua() {
  if (!peliKaynnissa) return;

  for (let i = 0; i < nykyinen.length; i++) {
    const r = Math.floor(i / koko);
    const c = i % koko;
    const oikea = ratkaisu[r][c];
    if (nykyinen[i] === oikea && !korostukset.has(i)) {
	  lukitut.add(i); // ‚Üê lukitaan oikeaan paikkaan asetettu tavu
      korostukset.add(i);
      valinta = null; // üîß Poistaa keltaisen valinnan
      render();
      return;
    }
  }
  alert("Ei l√∂ytynyt uutta oikeaa tavua paljastettavaksi.");
}



// Apufunktio: sekoittaa annetun taulukon
function shuffle(arr) {
  let a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}


    // Ladataan sanalista heti sivun alussa
    lataaSanat().then(() => console.log("Sanalista ladattu."));
	
	if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker rekister√∂ity'))
    .catch(err => console.error('SW virhe', err));
}

  </script>
  <footer style="
  position: fixed;
  bottom: 4px;
  right: 6px;
  font-size: 11px;
  color: #000000; /* musta teksti */
  //background-color: #ffa500; /* kirkas oranssi */
  padding: 4px 8px;
  z-index: 9999;
  //border: 1px solid #888;
  border-radius: 4px;
  //box-shadow: 1px 1px 4px rgba(0,0,0,0.2);
  font-family: sans-serif;
">
  Versio 1.0.1
</footer>
</body>
</html>
