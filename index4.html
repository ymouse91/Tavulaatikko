<!DOCTYPE html>
<html lang="fi">
<head>
  <!--
    Tavupeli "Tavulaatikko" / "Tavukko"
    -----------------------------------
    Selainpohjainen sanapeli 3×3 tai 4×4 -ruudukolle.
    Jokaisen vaaka- ja pystysuuntaisen tavuparin tulee muodostaa oikea suomenkielinen kaksitavuinen sana.
  -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#cfc">
  <title>Tavukko</title>
  <link rel="manifest" href="manifest4.json">

<style>
    /* Yleiset tyylit */
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
    }

    /* Ruudukko-asettelu */
    .grid {
      display: grid;
      gap: 5px;
      justify-content: center;
      margin: 20px auto;
    }

    /* Ruudukon napit */
    .grid button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #888;
      background-color: #f0f0f0;
      cursor: pointer;
      transition: background 0.2s ease;
      width: 60px;
      height: 60px;
      font-size: 18px;
      font-weight: bold;
    }

    /* Oikein asetetut tavut vihreäksi */
    .grid button.correct {
      background-color: #cfc;
    }

    /* Väärän valinnan välähdys punaisena */
    .grid button.flash-error {
      background-color: #fcc !important;
    }

    /* Pelin kontrollipainikkeet */
    .controls {
      margin-bottom: 15px;
    }

    /* Voittotekstin ulkoasu */
    .won {
      font-weight: bold;
      color: green;
      font-size: 1.4em;
    }

    /* Vieritettävä laatikko (ratkaisut) */
    .scroll-box {
      max-height: 280px;
      overflow-y: auto;
      margin: 10px auto;
      padding: 10px;
      border: 1px solid #ccc;
      width: 60%;
      min-width: 180px;
      max-width: 280px;
      background: #f9f9f9;
      text-align: left;
      font-size: 18px;
    }

    /* Valintalistan ja napin koko */
    #sizeLabel,
    #size {
      font-size: 16px;
      font-weight: bold;
	  border-radius: 24px;
      padding: 6px 12px;
    }

    /* Hover-tyylit */
    button:hover {
      background-color: #ddd;
    }

    #startBtn:hover {
      background-color: #cfc;
    }

    #lopetaBtn:hover {
      background-color: #fdd;
    }

    #apuaBtn:hover {
      background-color: #fffbcc;
    }

    /* Painikkeiden perustyyli */
    button {
      font-size: 16px;
      padding: 6px 12px;
      border-radius: 24px;
      border: 1px solid #888;
      background-color: #f0f0f0;
      cursor: pointer;
      margin: 4px;
    }
	

    /* Linkkien tyyli vierityslaatikossa */
    .scroll-box a {
      text-decoration: none;
      color: #000;
    }

    .scroll-box a:hover {
      text-decoration: underline;
      color: #0077cc;
    }
</style>

</head>
<body>
  <!-- Ohjeet dialogina -->
  <dialog id="ohjeet" style="max-width: 600px; width: 90%; text-align: left;">
    <h2>Ohjeet</h2>
    <p><strong>Tavukko</strong> on sanapeli, jossa tavoitteena on muodostaa täysi ruudukko suomenkielisiä kaksitavuisia sanoja.</p>
    <ul>
      <li>Valitse ruudukon koko: 3×3 tai 4×4.</li>
      <li>Paina <strong>Aloita peli</strong>. Tavut ilmestyvät ruudukkoon.</li>
      <li>Valitse kaksi ruutua vuorotellen vaihtaaksesi niiden paikkaa.</li>
      <li>Tavoitteena on, että jokainen <strong>tavupari</strong> vasemmalta oikealle ja ylhäältä alas muodostaa oikean sanan.</li>
      <li>Vihreät ruudut ovat oikeassa paikassa, eikä niitä voi siirtää.</li>
      <li><strong>Apua</strong>-painikkeella voit paljastaa yhden oikealla paikalla olevan tavun tai siirtää valitun tavun oikealle paikalle.</li>
      <li><strong>Lopeta</strong>-painike näyttää oikean ratkaisun ja kaikki sanat. Sanojen selityksen löydät klikkaamalla sanaa.</li>
    </ul>
    <div style="text-align: center; margin-top: 20px;">
      <button onclick="document.getElementById('ohjeet').close()" id="okBtn">OK</button>
    </div>
  </dialog>

  <h1>
    <button onclick="document.getElementById('ohjeet').showModal()" style="font-size: 1.5em; font-weight: bold; border: none; background: none; cursor: pointer;">Tavukko</button>
  </h1>

  <!-- Pelin ohjauspainikkeet -->
  <div class="controls">
    <label for="size" id="sizeLabel">Ruudukko:</label>
    <select id="size">
      <option value="3" selected> 3×3 </option>
      <option value="4"> 4×4 </option>
	  <option value="5"> 5×5 </option>
    </select>
    <button id="startBtn" onclick="startGame()" disabled>Aloita peli</button>
    <button id="lopetaBtn" onclick="naytaRatkaisu()" style="display:none">Lopeta</button>
    <button id="apuaBtn" onclick="annaApua()" style="display:none">Apua</button>
  </div>

  <!-- Varsinainen ruudukko -->
  <div id="grid" class="grid"></div>

  <!-- Voitto-/ratkaisulaatikko -->
  <div id="status" class="won"></div>

  <script>
  // -----------------------------
  // TÄMÄ ON KOKO PELIN TOIMINNALLINEN LOGIIKKA
  // -----------------------------

  // Haetaan tarvittavat HTML-elementit
  const gridElem = document.getElementById("grid");
  const statusElem = document.getElementById("status");
  const startBtn = document.getElementById("startBtn");
  const lopetaBtn = document.getElementById("lopetaBtn");

  // Pelitila
  let koko = 3;
  let ratkaisu = [];            // 2D-taulukko (n×n)
  let nykyinen = [];            // 1D-taulukko (n*n) renderöintiä varten
  let valinta = null;
  let peliKaynnissa = true;
  let korostukset = new Set();
  let lukitut = new Set();
  let sallitutSanat = new Set();
  let tavulista = [];
  let vilautusIndeksi = null;
  let apuVaihtoja = 0;
  let apuPaljastuksia = 0;

  // Kielletyt
  const kielletytSanat = new Set([
    "per-se", "a-nus", "vit-tu", "kyr-pä", "pimp-pi", "tis-si",
    "ku-si", "kak-ka", "pas-ka", "ho-mo", "les-bo", "sek-si",
    "nän-ni", "ka-lu", "pil-lu"
  ]);

  // Yleiset apufunktiot
  function shuffle(arr) {
    let a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function flatten2D(arr) {
    if (!arr) return [];
    const out = [];
    for (let i = 0; i < arr.length; i++) {
      const row = arr[i] || [];
      for (let j = 0; j < row.length; j++) out.push(row[j]);
    }
    return out;
  }

  // Lataa sanat
  async function lataaSanat() {
    const response = await fetch("sallitut_sanat.txt");
    const teksti = await response.text();

    // Vältetään flatMap - käytetään map + concat
    const rivit = teksti.split(/\r?\n/).filter(r => r.includes("-") && !kielletytSanat.has(r));
    sallitutSanat = new Set(rivit);

    const kaikkiTavut = [].concat(...rivit.map(r => r.split("-")));
    const laskuri = {};
    for (const t of kaikkiTavut) {
      laskuri[t] = (laskuri[t] || 0) + 1;
    }
    tavulista = Object.keys(laskuri);

    startBtn.disabled = false;
  }

  // Rekisteröi SW
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker4.js')
      .then(() => console.log('Service Worker rekisteröity'))
      .catch(err => console.error('SW virhe', err));
  }

  // Esilataus
  lataaSanat().then(() => console.log("Sanalista ladattu."));

  // Aloita peli
function startGame() {
  // Piilota valinnat, näytä pelipainikkeet
  document.getElementById("size").style.display = "none";
  document.getElementById("sizeLabel").style.display = "none";
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("lopetaBtn").style.display = "inline-block";
  document.getElementById("apuaBtn").style.display = "inline-block";

  apuVaihtoja = 0;
  apuPaljastuksia = 0;
  statusElem.innerHTML = "";

  if (sallitutSanat.size === 0) {
    alert("Sanoja ei ladattu.");
    return;
  }

  koko = parseInt(document.getElementById("size").value, 10);

  // *** UUSI: backtracking -palauttaa aina 2D-taulukon ***
  ratkaisu = generoiKelvollinenRuudukko(koko);

  // Valmistellaan aloitustila
  const tavut = flatten2D(ratkaisu);
  korostukset.clear();
  lukitut.clear();
  let oikeatIndeksit = [];

  // --- Päivitetty lukituslogiikka: 3x3 -> 1, 4x4 -> 2, 5x5 -> 3 (eri rivi & sarake) ---
  const lukittavienMaara = (koko === 3) ? 1 : (koko === 4) ? 2 : 3;
  const rivi = (i) => Math.floor(i / koko);
  const sarake = (i) => i % koko;
  const satunnainen = (arr) => arr[Math.floor(Math.random() * arr.length)];
  const kaikkiIndeksit = [...Array(tavut.length).keys()];

  // 1) ensimmäinen vapaasti
  oikeatIndeksit.push(satunnainen(kaikkiIndeksit));

  // 2) loput niin, ettei tule samaa riviä tai saraketta aiempien kanssa
  while (oikeatIndeksit.length < lukittavienMaara) {
    const kelvolliset = kaikkiIndeksit.filter((i) =>
      !oikeatIndeksit.includes(i) &&
      oikeatIndeksit.every((j) => rivi(i) !== rivi(j) && sarake(i) !== sarake(j))
    );
    if (kelvolliset.length === 0) break; // varalta, käytännössä 5x5:ssä löytyy
    oikeatIndeksit.push(satunnainen(kelvolliset));
  }

  // --- Asetus ilman splice-indeksisiirtymiä ---
  const lukitutSet = new Set(oikeatIndeksit);
  const tavutIlman = tavut.filter((_, i) => !lukitutSet.has(i));
  const sekoitetut = shuffle(tavutIlman);

  // alustetaan aloituspaikat
  const aloitus = Array(tavut.length).fill(null);

  // aseta lukitut oikeille paikoilleen ja merkitse ne
  for (const idx of oikeatIndeksit) {
    aloitus[idx] = tavut[idx];
    korostukset.add(idx);
    lukitut.add(idx);
  }

  // täytä loput sekoitetuilla
  let p = 0;
  for (let i = 0; i < aloitus.length; i++) {
    if (aloitus[i] === null) aloitus[i] = sekoitetut[p++];
  }

  nykyinen = aloitus;
  // --- /lukituslogiikan päivitys ---

  peliKaynnissa = true;
  valinta = null;
  render();

  // Alkuanimaatio
  const ruudut = document.querySelectorAll(".grid button");
  ruudut.forEach((btn, i) => {
    setTimeout(() => {
      btn.style.transition = "transform 0.3s ease, background-color 0.3s ease";
      btn.style.transform = "scale(1.15)";
      if (!btn.classList.contains("correct")) {
        btn.style.backgroundColor = "#cfc";
      }
      setTimeout(() => {
        btn.style.transform = "scale(1)";
        if (!btn.classList.contains("correct")) {
          btn.style.backgroundColor = "#f0f0f0";
        }
      }, 300);
    }, i * 30);
  });
}


  // Renderöi ruudukko
  function render() {
    gridElem.style.gridTemplateColumns = `repeat(${koko}, 60px)`;
    gridElem.innerHTML = "";

    for (let i = 0; i < koko * koko; i++) {
      const btn = document.createElement("button");
      btn.textContent = nykyinen[i];
      btn.onclick = () => valitseTaiVaihda(i);

      if (valinta === i) btn.style.background = "#ffc";       // Valittu
      if (korostukset.has(i)) btn.classList.add("correct");    // Oikein
      if (i === vilautusIndeksi) btn.classList.add("flash-error"); // Kielto

      gridElem.appendChild(btn);
    }
  }

  // Klikkilogiikka
  function valitseTaiVaihda(i) {
    if (!peliKaynnissa) return;

    if (lukitut.has(i)) {
      vilautusIndeksi = i;
      render();
      setTimeout(() => {
        vilautusIndeksi = null;
        render();
      }, 400);
      return;
    }

    if (valinta === null) {
      valinta = i;
    } else if (valinta === i) {
      valinta = null;
    } else {
      if (lukitut.has(i) || lukitut.has(valinta)) return;
      [nykyinen[i], nykyinen[valinta]] = [nykyinen[valinta], nykyinen[i]];
      valinta = null;
      render();
      setTimeout(() => tarkistaVoitto(), 20);
    }
    render();
  }

  // *** UUSI: Backtracking-generaattori ***
  function generoiKelvollinenRuudukko(n) {
    const grid = Array.from({ length: n }, () => Array(n).fill(""));
    const kaytetyt = {}; // tavu -> lukumäärä (max 1)

    function kelpaa(r, c, t) {
      // vasen
      if (c > 0) {
        const v = grid[r][c - 1];
        if (!sallitutSanat.has(v + "-" + t)) return false;
      }
      // ylä
      if (r > 0) {
        const y = grid[r - 1][c];
        if (!sallitutSanat.has(y + "-" + t)) return false;
      }
      return true;
    }

    function bt(pos) {
      if (pos === n * n) return true;
      const r = Math.floor(pos / n);
      const c = pos % n;

      const ehdokkaat = shuffle(tavulista.slice());
      for (const t of ehdokkaat) {
        if ((kaytetyt[t] || 0) >= 1) continue; // sallittu vain kerran
        if (!kelpaa(r, c, t)) continue;
        grid[r][c] = t;
        kaytetyt[t] = (kaytetyt[t] || 0) + 1;
        if (bt(pos + 1)) return true;
        kaytetyt[t]--;
        grid[r][c] = "";
      }
      return false;
    }

    if (!bt(0)) {
      alert("Ei onnistuttu muodostamaan kelvollista ruudukkoa.");
      return Array.from({ length: n }, () => Array(n).fill("??"));
    }
    return grid;
  }

  // Voittotarkistus
  function tarkistaVoitto() {
    const grid = [];
    for (let r = 0; r < koko; r++) {
      grid.push(nykyinen.slice(r * koko, (r + 1) * koko));
    }

    for (let r = 0; r < koko; r++) {
      for (let c = 0; c < koko; c++) {
        if (c < koko - 1 && !sallitutSanat.has(`${grid[r][c]}-${grid[r][c + 1]}`)) return;
        if (r < koko - 1 && !sallitutSanat.has(`${grid[r][c]}-${grid[r + 1][c]}`)) return;
      }
    }

    // Voittoanimaatio
    const ruudut = document.querySelectorAll(".grid button");
    ruudut.forEach((btn, i) => {
      setTimeout(() => {
        btn.style.transition = "transform 0.3s ease, background-color 0.3s ease";
        btn.style.transform = "scale(1.15)";
        btn.style.backgroundColor = "#dfffd0";
        setTimeout(() => {
          btn.style.transform = "scale(1)";
        }, 300);
      }, i * 30);
    });

    // Pisteytys ja sanojen näyttö
    setTimeout(() => {
      const vaaka = [], pysty = [];
      for (let r = 0; r < koko; r++) {
        for (let c = 0; c < koko - 1; c++) {
          vaaka.push(`${grid[r][c]}-${grid[r][c + 1]}`);
        }
      }
      for (let c = 0; c < koko; c++) {
        for (let r = 0; r < koko - 1; r++) {
          pysty.push(`${grid[r][c]}-${grid[r + 1][c]}`);
        }
      }

      document.getElementById("size").style.display = "inline-block";
      document.getElementById("sizeLabel").style.display = "inline-block";
      document.getElementById("startBtn").style.display = "inline-block";
      document.getElementById("lopetaBtn").style.display = "none";
      document.getElementById("apuaBtn").style.display = "none";
      peliKaynnissa = false;

      let paljastamattomia = nykyinen.length - korostukset.size;
      let maxPisteet = koko === 3 ? 10 : 20;
      let pisteet = 0;
      if (paljastamattomia >= 3) {
        pisteet = maxPisteet - (2 * apuVaihtoja) - (1 * apuPaljastuksia);
        if (pisteet < 0) pisteet = 0;
      } else {
        pisteet = 0;
      }

      naytaSanat(vaaka, pysty, `Voitit! Pisteesi: <b>${pisteet}</b>`);
    }, koko * koko * 30 + 500);
  }

  // Ratkaisun näyttö
  function naytaRatkaisu() {
    document.getElementById("size").style.display = "inline-block";
    document.getElementById("sizeLabel").style.display = "inline-block";
    document.getElementById("startBtn").style.display = "inline-block";
    document.getElementById("lopetaBtn").style.display = "none";
    document.getElementById("apuaBtn").style.display = "none";

    nykyinen = flatten2D(ratkaisu);   // .flat() -> flatten2D
    peliKaynnissa = false;
    render();

    const vaaka = [], pysty = [];
    for (let r = 0; r < koko; r++) {
      for (let c = 0; c < koko - 1; c++) {
        vaaka.push(`${ratkaisu[r][c]}-${ratkaisu[r][c + 1]}`);
      }
    }
    for (let c = 0; c < koko; c++) {
      for (let r = 0; r < koko - 1; r++) {
        pysty.push(`${ratkaisu[r][c]}-${ratkaisu[r + 1][c]}`);
      }
    }
    naytaSanat(vaaka, pysty, "Ratkaisun sanat.");
  }

  // Sanalista linkkeineen
function naytaSanat(vaaka, pysty, otsikko) {
  statusElem.innerHTML = `
    <div>${otsikko}</div>
    <div class="scroll-box" style="display: flex; gap: 20px; justify-content: center;">
      <div><b>Vaakaan:</b><br>
        ${vaaka.map(s => `<a href='https://www.kielitoimistonsanakirja.fi/#/${s.replace("-", "").toLowerCase()}' target='_blank'>${s.replace("-", "")}</a>`).join("<br>")}
      </div>
      <div><b>Pystyyn:</b><br>
        ${pysty.map(s => `<a href='https://www.kielitoimistonsanakirja.fi/#/${s.replace("-", "").toLowerCase()}' target='_blank'>${s.replace("-", "")}</a>`).join("<br>")}
      </div>
    </div>`;
}

  // Apupainike
  function annaApua() {
    if (!peliKaynnissa) return;

    // Jos on valinta, siirrä/korosta valitun tavun oikea paikka
    if (valinta !== null) {
      const valittuTavu = nykyinen[valinta];
      for (let i = 0; i < nykyinen.length; i++) {
        const r = Math.floor(i / koko);
        const c = i % koko;
        if (ratkaisu[r][c] === valittuTavu) {
          if (i === valinta) {
            lukitut.add(i);
            korostukset.add(i);
            apuVaihtoja++;
          } else {
            [nykyinen[i], nykyinen[valinta]] = [nykyinen[valinta], nykyinen[i]];
            lukitut.add(i);
            korostukset.add(i);
            apuVaihtoja++;
          }
          valinta = null;
          render();
          return;
        }
      }
    }

    // Muuten paljasta seuraava oikea tavu
    for (let i = 0; i < nykyinen.length; i++) {
      const r = Math.floor(i / koko);
      const c = i % koko;
      if (nykyinen[i] === ratkaisu[r][c] && !korostukset.has(i)) {
        lukitut.add(i);
        korostukset.add(i);
        apuPaljastuksia++;
        valinta = null;
        render();
        return;
      }
    }

    alert("Ei löytynyt uutta oikeaa tavua paljastettavaksi.");
  }
  </script>

  <!-- Alareunan versioteksti -->
  <footer style="position: fixed; bottom: 4px; right: 6px; font-size: 11px;">
    Versio 1.0.9s (index4x4 backtracking + flatten2D)
  </footer>
</body>
</html>
